name: Sync All Issues to Project (Manual)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual changes)'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-all-labels:
    runs-on: ubuntu-latest
    
    steps:
      - name: Sync All Issues Priority and Size to Project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const dryRun = ${{ inputs.dry_run }};
            
            // Project configuration
            const PROJECT_NUMBER = 5;
            const OWNER = context.repo.owner;
            const REPO = context.repo.repo;
            
            console.log(`Starting sync for all issues${dryRun ? ' (DRY RUN)' : ''}...`);
            
            // Get project ID and fields
            const projectQuery = `
              query($owner: String!, $number: Int!) {
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const projectResult = await github.graphql(projectQuery, {
              owner: OWNER,
              number: PROJECT_NUMBER
            });
            
            const project = projectResult.user.projectV2;
            if (!project) {
              throw new Error('Project not found');
            }
            
            // Find Priority and Size fields
            const priorityField = project.fields.nodes.find(field => field.name === 'Priority');
            const sizeField = project.fields.nodes.find(field => field.name === 'Size');
            
            if (!priorityField || !sizeField) {
              throw new Error('Priority or Size field not found in project');
            }
            
            console.log('Available Priority options:', priorityField.options.map(o => o.name));
            console.log('Available Size options:', sizeField.options.map(o => o.name));
            
            // Get all open issues
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: OWNER,
              repo: REPO,
              state: 'open',
              per_page: 100
            });
            
            console.log(`Found ${issues.length} open issues`);
            
            // Mapping functions
            function mapPriorityLabel(labelName) {
              if (!labelName) return null;
              const priority = labelName.replace('priority/', '');
              switch (priority.toLowerCase()) {
                case 'low': return 'Low';
                case 'medium': return 'Medium';
                case 'high': return 'High';
                case 'critical': return 'Critical';
                default: return null;
              }
            }
            
            function mapSizeLabel(labelName) {
              if (!labelName) return null;
              const size = labelName.replace('size/', '');
              return size.toUpperCase(); // XS, S, M, L, XL
            }
            
            let processed = 0;
            let updated = 0;
            
            for (const issue of issues) {
              console.log(`\n--- Processing Issue #${issue.number}: ${issue.title} ---`);
              
              // Find priority and size labels
              const priorityLabel = issue.labels.find(label => label.name && label.name.startsWith('priority/'));
              const sizeLabel = issue.labels.find(label => label.name && label.name.startsWith('size/'));
              
              console.log('Priority label:', priorityLabel?.name || 'none');
              console.log('Size label:', sizeLabel?.name || 'none');
              
              if (!priorityLabel && !sizeLabel) {
                console.log('No priority or size labels found, skipping');
                continue;
              }
              
              // Get project item for this issue
              const itemQuery = `
                query($owner: String!, $repo: String!, $issueNumber: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $issueNumber) {
                      projectItems(first: 10) {
                        nodes {
                          id
                          project {
                            id
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const itemResult = await github.graphql(itemQuery, {
                owner: OWNER,
                repo: REPO,
                issueNumber: issue.number
              });
              
              const projectItem = itemResult.repository.issue.projectItems.nodes.find(
                item => item.project.id === project.id
              );
              
              if (!projectItem) {
                console.log('Issue not found in project, skipping');
                continue;
              }
              
              processed++;
              
              // Update Priority field
              if (priorityLabel) {
                const priorityValue = mapPriorityLabel(priorityLabel.name);
                if (priorityValue) {
                  const priorityOption = priorityField.options.find(opt => opt.name === priorityValue);
                  if (priorityOption) {
                    if (!dryRun) {
                      const updateMutation = `
                        mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                          updateProjectV2ItemFieldValue(
                            input: {
                              projectId: $projectId
                              itemId: $itemId
                              fieldId: $fieldId
                              value: { singleSelectOptionId: $optionId }
                            }
                          ) {
                            projectV2Item {
                              id
                            }
                          }
                        }
                      `;
                      
                      await github.graphql(updateMutation, {
                        projectId: project.id,
                        itemId: projectItem.id,
                        fieldId: priorityField.id,
                        optionId: priorityOption.id
                      });
                      
                      console.log(`âœ… Updated priority to: ${priorityValue}`);
                    } else {
                      console.log(`ðŸ”„ Would update priority to: ${priorityValue}`);
                    }
                    updated++;
                  } else {
                    console.log(`âŒ Priority option '${priorityValue}' not found`);
                  }
                } else {
                  console.log(`âŒ Could not map priority label '${priorityLabel.name}'`);
                }
              }
              
              // Update Size field
              if (sizeLabel) {
                const sizeValue = mapSizeLabel(sizeLabel.name);
                if (sizeValue) {
                  const sizeOption = sizeField.options.find(opt => opt.name === sizeValue);
                  if (sizeOption) {
                    if (!dryRun) {
                      const updateMutation = `
                        mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                          updateProjectV2ItemFieldValue(
                            input: {
                              projectId: $projectId
                              itemId: $itemId
                              fieldId: $fieldId
                              value: { singleSelectOptionId: $optionId }
                            }
                          ) {
                            projectV2Item {
                              id
                            }
                          }
                        }
                      `;
                      
                      await github.graphql(updateMutation, {
                        projectId: project.id,
                        itemId: projectItem.id,
                        fieldId: sizeField.id,
                        optionId: sizeOption.id
                      });
                      
                      console.log(`âœ… Updated size to: ${sizeValue}`);
                    } else {
                      console.log(`ðŸ”„ Would update size to: ${sizeValue}`);
                    }
                    updated++;
                  } else {
                    console.log(`âŒ Size option '${sizeValue}' not found`);
                  }
                } else {
                  console.log(`âŒ Could not map size label '${sizeLabel.name}'`);
                }
              }
              
              // Add small delay to avoid rate limiting
              await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.log(`\n=== SUMMARY ===`);
            console.log(`Total issues: ${issues.length}`);
            console.log(`Processed: ${processed}`);
            console.log(`Updates made: ${updated}${dryRun ? ' (simulated)' : ''}`);
            console.log('Sync completed!');