name: Quality Gates

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  push:
    branches: [main]

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type checking
        run: npm run typecheck
        continue-on-error: false
      
      - name: Build check
        run: npm run build
        continue-on-error: false
      
      - name: Update PR status
        if: success()
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d '{
              "body": "‚úÖ **Quality Gates Passed**\n\n- Type checking: ‚úÖ\n- Build: ‚úÖ\n\nThis PR is ready for code review!"
            }'

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run security audit
        run: |
          npm audit --audit-level high
        continue-on-error: true
      
      - name: Check for sensitive files
        run: |
          # Check for common sensitive files
          SENSITIVE_FILES=$(find . -name "*.env*" -o -name "*.key" -o -name "*.pem" -o -name "config.json" | grep -v node_modules || true)
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "Warning: Potential sensitive files found:"
            echo "$SENSITIVE_FILES"
            exit 1
          fi

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build for production
        run: npm run build
      
      - name: Check bundle size
        run: |
          # Simple bundle size check - you can enhance this with more sophisticated tools
          BUILD_SIZE=$(du -sh build/ | cut -f1)
          echo "Build size: $BUILD_SIZE"
          
          # Add comment to PR with build size
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d "{
              \"body\": \"üìä **Performance Report**\\n\\nBuild size: \`$BUILD_SIZE\`\\n\\n_Automated performance check completed._\"
            }"

  accessibility-check:
    name: Accessibility Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          # Install accessibility testing tools
          npm install --no-save @axe-core/cli pa11y
      
      - name: Build application
        run: npm run build
      
      - name: Start application
        run: |
          npm start &
          # Wait for application to start
          sleep 10
        timeout-minutes: 2
      
      - name: Run accessibility tests
        run: |
          # Run axe-core accessibility tests
          npx axe http://localhost:3000 --save accessibility-report.json || true
          
          # Check if report exists and has violations
          if [ -f accessibility-report.json ]; then
            VIOLATIONS=$(jq '.violations | length' accessibility-report.json)
            if [ "$VIOLATIONS" -gt 0 ]; then
              echo "Accessibility violations found: $VIOLATIONS"
              # Post summary to PR
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
                -d "{
                  \"body\": \"‚ö†Ô∏è **Accessibility Check**\\n\\n$VIOLATIONS accessibility violations found. Please review and fix before merging.\"
                }"
            else
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
                -d '{
                  "body": "‚úÖ **Accessibility Check Passed**\n\nNo accessibility violations found!"
                }'
            fi
          fi

  integration-ready:
    name: Integration Ready Check
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, performance-check]
    if: github.event_name == 'pull_request' && always()
    steps:
      - name: Check all quality gates
        run: |
          if [[ "${{ needs.code-quality.result }}" == "success" && 
                "${{ needs.security-scan.result }}" == "success" && 
                "${{ needs.performance-check.result }}" == "success" ]]; then
            echo "All quality gates passed"
            # Add ready-for-testing label
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels" \
              -d '{"labels":["ready-for-testing"]}'
          else
            echo "Some quality gates failed"
            # Add needs-fixes label
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels" \
              -d '{"labels":["needs-fixes"]}'
          fi