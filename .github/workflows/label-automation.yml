name: Label and Project Automation

on:
  issues:
    types: [opened, labeled, unlabeled]
  pull_request:
    types: [opened, labeled, unlabeled, closed]

jobs:
  auto-label-issues:
    name: Auto Label Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Add default labels to new issues
        run: |
          # Add 'Backlog' label to new issues
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels" \
            -d '{"labels":["Backlog", "Needs-Analysis"]}'

  priority-labeling:
    name: Priority Based Movement
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && 
      github.event.action == 'labeled' && 
      (github.event.label.name == 'P0' || github.event.label.name == 'P1' || github.event.label.name == 'P2' || github.event.label.name == 'P3')
    steps:
      - name: Move high priority to À Faire
        if: github.event.label.name == 'P0' || github.event.label.name == 'P1'
        uses: alex-page/github-project-automation-plus@v0.9.0
        with:
          project: Shooting Star Project
          column: À Faire
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Assign critical issues immediately
        if: github.event.label.name == 'P0'
        run: |
          # Auto-assign critical issues to project maintainer
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/assignees" \
            -d '{"assignees":["${{ github.repository_owner }}"]}'

  type-based-automation:
    name: Issue Type Automation
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && 
      github.event.action == 'labeled'
    steps:
      - name: Handle bug reports
        if: github.event.label.name == 'Bug'
        run: |
          # Add bug template comment
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -d '{
              "body": "## Bug Report Received\n\nThank you for reporting this bug! Please ensure you have provided:\n\n- [ ] Steps to reproduce\n- [ ] Expected behavior\n- [ ] Actual behavior\n- [ ] Environment details\n- [ ] Screenshots (if applicable)\n\nThis issue will be triaged and prioritized accordingly."
            }'
          
          # Add additional labels
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels" \
            -d '{"labels":["Needs-Analysis"]}'
      
      - name: Handle feature requests
        if: github.event.label.name == 'Enhancement' || github.event.label.name == 'Feature'
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -d '{
              "body": "## Feature Request Received\n\nThank you for your feature request! This will be reviewed by the team and prioritized based on:\n\n- Impact on users\n- Alignment with project goals\n- Development effort required\n- Community interest\n\nWe appreciate your input!"
            }'