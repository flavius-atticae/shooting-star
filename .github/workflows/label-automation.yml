name: Label and Project Automation

on:
  issues:
    types: [opened, labeled, unlabeled]
  pull_request:
    types: [opened, labeled, unlabeled, closed]

jobs:
  auto-label-issues:
    name: Auto Label Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Add default labels to new issues
        run: |
          # Add 'triage' label to new issues
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels" \
            -d '{"labels":["triage", "needs-analysis"]}'

  priority-labeling:
    name: Priority Based Movement
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && 
      github.event.action == 'labeled' && 
      contains(github.event.label.name, 'priority/')
    steps:
      - name: Move high priority to À Faire
        if: github.event.label.name == 'priority/high' || github.event.label.name == 'priority/critical'
        uses: alex-page/github-project-automation-plus@v0.9.0
        with:
          project: Shooting Star Project
          column: À Faire
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Assign critical issues immediately
        if: github.event.label.name == 'priority/critical'
        run: |
          # Auto-assign critical issues to project maintainer
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/assignees" \
            -d '{"assignees":["${{ github.repository_owner }}"]}'

  type-based-automation:
    name: Issue Type Automation
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && 
      github.event.action == 'labeled'
    steps:
      - name: Handle bug reports
        if: contains(github.event.label.name, 'bug')
        run: |
          # Add bug template comment
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -d '{
              "body": "## Bug Report Received\n\nThank you for reporting this bug! Please ensure you have provided:\n\n- [ ] Steps to reproduce\n- [ ] Expected behavior\n- [ ] Actual behavior\n- [ ] Environment details\n- [ ] Screenshots (if applicable)\n\nThis issue will be triaged and prioritized accordingly."
            }'
          
          # Add additional labels
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels" \
            -d '{"labels":["needs-reproduction"]}'
      
      - name: Handle feature requests
        if: contains(github.event.label.name, 'enhancement') || contains(github.event.label.name, 'feature')
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" \
            -d '{
              "body": "## Feature Request Received\n\nThank you for your feature request! This will be reviewed by the team and prioritized based on:\n\n- Impact on users\n- Alignment with project goals\n- Development effort required\n- Community interest\n\nWe appreciate your input!"
            }'

  stale-issue-management:
    name: Stale Issue Management
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Mark stale issues
        uses: actions/stale@v8
        with:
          stale-issue-message: |
            This issue has been automatically marked as stale because it has not had recent activity. 
            It will be closed if no further activity occurs within 7 days. 
            If this issue is still relevant, please comment to keep it open.
          stale-pr-message: |
            This pull request has been automatically marked as stale because it has not had recent activity. 
            It will be closed if no further activity occurs within 7 days.
          close-issue-message: |
            This issue has been automatically closed due to inactivity. 
            If you believe this issue is still relevant, please reopen it with updated information.
          close-pr-message: |
            This pull request has been automatically closed due to inactivity. 
            If you would like to continue working on this, please reopen it.
          days-before-stale: 30
          days-before-close: 7
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          exempt-issue-labels: 'priority/high,priority/critical,pinned'
          exempt-pr-labels: 'priority/high,priority/critical,pinned'