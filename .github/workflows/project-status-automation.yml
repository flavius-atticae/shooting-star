name: Project Status Automation

on:
  issues:
    types: [labeled, unlabeled, assigned, unassigned]

jobs:
  update-project-status:
    runs-on: ubuntu-latest
    if: github.event.issue
    
    steps:
      - name: Update Project Status Based on Labels and Assignment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const issue = context.payload.issue;
            const action = context.payload.action;
            
            // Project configuration
            const PROJECT_NUMBER = 5;
            const OWNER = context.repo.owner;
            const REPO = context.repo.repo;
            
            console.log(`Processing ${action} action for issue #${issue.number}: ${issue.title}`);
            
            // Get project ID and fields
            const projectQuery = `
              query($owner: String!, $number: Int!) {
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                          dataType
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          dataType
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const projectResult = await github.graphql(projectQuery, {
              owner: OWNER,
              number: PROJECT_NUMBER
            });
            
            const project = projectResult.user.projectV2;
            if (!project) {
              console.log('Project not found');
              return;
            }
            
            // Find status field
            const statusField = project.fields.nodes.find(field => field.name === 'Status');
            
            if (!statusField) {
              console.log('Status field not found in project');
              return;
            }
            
            console.log('Found status field:', statusField.id);
            
            // Get project item for this issue
            const itemQuery = `
              query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                      }
                    }
                    labels(first: 20) {
                      nodes {
                        name
                      }
                    }
                    assignees(first: 10) {
                      nodes {
                        login
                      }
                    }
                  }
                }
              }
            `;
            
            const itemResult = await github.graphql(itemQuery, {
              owner: OWNER,
              repo: REPO,
              issueNumber: issue.number
            });
            
            const projectItem = itemResult.repository.issue.projectItems.nodes.find(
              item => item.project.id === project.id
            );
            
            if (!projectItem) {
              console.log('Issue not found in project');
              return;
            }
            
            const labels = itemResult.repository.issue.labels.nodes.map(label => label.name);
            const assignees = itemResult.repository.issue.assignees.nodes.map(assignee => assignee.login);
            
            console.log('Current labels:', labels);
            console.log('Current assignees:', assignees);
            
            // Status mapping: label -> project status ID
            const statusMap = {
              'status/triage': 'f75ad846',        // Backlog
              'status/ready': '08afe404',         // Ã€ Faire
              'status/in-development': '47fc9ee4', // En Cours
              'status/needs-review': '4cc61d42',   // Review
              'status/ready-for-testing': 'd2573237', // Testing
              'status/completed': '98236657',      // Done
              'status/released': '111ec098'        // Released
            };
            
            // Helper function to update project status
            async function updateProjectStatus(statusOptionId) {
              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { singleSelectOptionId: $optionId }
                    }
                  ) {
                    projectV2Item { id }
                  }
                }
              `;
              
              await github.graphql(mutation, {
                projectId: project.id,
                itemId: projectItem.id,
                fieldId: statusField.id,
                optionId: statusOptionId
              });
            }
            
            // Helper function to add/remove labels
            async function updateIssueLabel(labelName, shouldAdd) {
              if (shouldAdd) {
                // Add label if not already present
                if (!labels.includes(labelName)) {
                  await github.rest.issues.addLabels({
                    owner: OWNER,
                    repo: REPO,
                    issue_number: issue.number,
                    labels: [labelName]
                  });
                  console.log(`âœ… Added label: ${labelName}`);
                }
              } else {
                // Remove label if present
                if (labels.includes(labelName)) {
                  try {
                    await github.rest.issues.removeLabel({
                      owner: OWNER,
                      repo: REPO,
                      issue_number: issue.number,
                      name: labelName
                    });
                    console.log(`ðŸ—‘ï¸ Removed label: ${labelName}`);
                  } catch (error) {
                    if (error.status !== 404) {
                      console.error(`Error removing label ${labelName}:`, error);
                    }
                  }
                }
              }
            }
            
            try {
              // Determine the appropriate status based on labels and assignment
              let targetStatus = null;
              let targetStatusName = null;
              let shouldAddLabel = null;
              let shouldRemoveLabels = [];
              
              // Priority logic:
              // 1. If assigned and not already in-development -> set to in-development
              // 2. Check for explicit status labels in priority order
              
              if (assignees.length > 0 && !labels.includes('status/in-development')) {
                // Issue is assigned but not marked as in-development
                targetStatus = statusMap['status/in-development'];
                targetStatusName = 'En Cours';
                shouldAddLabel = 'status/in-development';
                // Remove conflicting status labels
                shouldRemoveLabels = ['status/triage', 'status/ready'];
              } else {
                // Check for status labels in priority order
                const statusLabels = [
                  'status/released',
                  'status/completed', 
                  'status/ready-for-testing',
                  'status/needs-review',
                  'status/in-development',
                  'status/ready',
                  'status/triage'
                ];
                
                for (const statusLabel of statusLabels) {
                  if (labels.includes(statusLabel)) {
                    targetStatus = statusMap[statusLabel];
                    targetStatusName = statusField.options.find(opt => opt.id === targetStatus)?.name;
                    break;
                  }
                }
              }
              
              // Apply changes if we determined a target status
              if (targetStatus && targetStatusName) {
                // Update project status
                await updateProjectStatus(targetStatus);
                console.log(`âœ… Updated project status to: ${targetStatusName}`);
                
                // Add label if needed
                if (shouldAddLabel) {
                  await updateIssueLabel(shouldAddLabel, true);
                }
                
                // Remove conflicting labels
                for (const labelToRemove of shouldRemoveLabels) {
                  await updateIssueLabel(labelToRemove, false);
                }
              } else {
                console.log('No status change needed');
              }
              
              console.log('Project status automation completed successfully');
              
            } catch (error) {
              console.error('Error updating project status:', error);
              // Don't fail the workflow, just log the error
            }