name: Project Board Automation

on:
  issues:
    types: [opened, assigned, closed, labeled, unlabeled]
  pull_request:
    types: [opened, closed, converted_to_draft, ready_for_review]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  release:
    types: [published]
  push:
    branches: [main]

env:
  PROJECT_ID: "PVT_kwHOA8KkFM4BBWOl"  # Shooting Star project #5
  STATUS_FIELD_ID: "PVTSSF_lAHOA8KkFM4BBWOlzgz4SvM"  # Status field
  # Status option IDs
  BACKLOG_ID: "f75ad846"
  A_FAIRE_ID: "08afe404"
  EN_COURS_ID: "47fc9ee4"
  REVIEW_ID: "4cc61d42"
  TESTING_ID: "d2573237"
  DONE_ID: "98236657"
  RELEASED_ID: "111ec098"

jobs:
  status-check:
    name: Project Automation Status
    runs-on: ubuntu-latest
    steps:
      - name: Automation Status
        run: |
          echo "✅ Project Board Automation is now ACTIVE!"
          echo ""
          echo "Configuration Status:"
          echo "✅ Project #5 'Shooting Star' configured"
          echo "✅ All 25 issues added to project"
          echo "✅ Milestone v1.0 created with all issues"
          echo "✅ PROJECT_PAT configured with project permissions"
          echo "✅ Automatic workflow ENABLED"
          echo ""
          echo "Automation Features:"
          echo "• Issues → À Faire (when assigned)"
          echo "• PRs → En Cours (when opened)"
          echo "• PRs → Review (when ready)"
          echo "• PRs → Testing (when approved)"
          echo "• Items → Done (when closed/merged)"
          echo "• Items → Released (on release)"

  move-to-ready:
    name: Move to À Faire
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' && 
      (github.event.action == 'assigned' || 
       (github.event.action == 'labeled' && contains(github.event.label.name, 'ready')))
    steps:
      - name: Get issue project item ID
        id: get_item
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              repository(owner: $owner, name: "shooting-star") {
                issue(number: $number) {
                  projectItems(first: 10) {
                    nodes {
                      id
                      project {
                        id
                      }
                    }
                  }
                }
              }
            }' -f owner=flavius-atticae -F number=${{ github.event.issue.number }} \
            --jq '.data.repository.issue.projectItems.nodes[] | select(.project.id == "'${{ env.PROJECT_ID }}'") | .id')
          
          if [ -z "$ITEM_ID" ]; then
            # Add issue to project first
            ITEM_ID=$(gh api graphql -f query='
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                  item {
                    id
                  }
                }
              }' -f projectId=${{ env.PROJECT_ID }} -f contentId=${{ github.event.issue.node_id }} \
              --jq '.data.addProjectV2ItemById.item.id')
          fi
          
          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT

      - name: Move issue to À Faire
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: {singleSelectOptionId: $optionId}
              }) {
                projectV2Item {
                  id
                }
              }
            }' -f projectId=${{ env.PROJECT_ID }} \
               -f itemId=${{ steps.get_item.outputs.item_id }} \
               -f fieldId=${{ env.STATUS_FIELD_ID }} \
               -f optionId=${{ env.A_FAIRE_ID }}

  move-to-in-progress:
    name: Move to En Cours
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      (github.event.action == 'opened' || github.event.action == 'ready_for_review')
    steps:
      - name: Extract issue number from PR
        id: issue
        run: |
          # Extract issue number from PR title or body
          ISSUE_NUMBER=$(echo "${{ github.event.pull_request.title }}" | grep -oE '#[0-9]+' | head -1 | cut -d'#' -f2)
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(echo "${{ github.event.pull_request.body }}" | grep -oE '#[0-9]+' | head -1 | cut -d'#' -f2)
          fi
          echo "number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
      
      - name: Get issue project item ID
        id: get_item
        if: steps.issue.outputs.number
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          ISSUE_NODE_ID=$(gh api repos/flavius-atticae/shooting-star/issues/${{ steps.issue.outputs.number }} --jq .node_id)
          
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              repository(owner: $owner, name: "shooting-star") {
                issue(number: $number) {
                  projectItems(first: 10) {
                    nodes {
                      id
                      project {
                        id
                      }
                    }
                  }
                }
              }
            }' -f owner=flavius-atticae -F number=${{ steps.issue.outputs.number }} \
            --jq '.data.repository.issue.projectItems.nodes[] | select(.project.id == "'${{ env.PROJECT_ID }}'") | .id')
          
          if [ -z "$ITEM_ID" ]; then
            # Add issue to project first
            ITEM_ID=$(gh api graphql -f query='
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                  item {
                    id
                  }
                }
              }' -f projectId=${{ env.PROJECT_ID }} -f contentId=$ISSUE_NODE_ID \
              --jq '.data.addProjectV2ItemById.item.id')
          fi
          
          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT

      - name: Move linked issue to En Cours
        if: steps.issue.outputs.number && steps.get_item.outputs.item_id
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: {singleSelectOptionId: $optionId}
              }) {
                projectV2Item {
                  id
                }
              }
            }' -f projectId=${{ env.PROJECT_ID }} \
               -f itemId=${{ steps.get_item.outputs.item_id }} \
               -f fieldId=${{ env.STATUS_FIELD_ID }} \
               -f optionId=${{ env.EN_COURS_ID }}

  move-to-review:
    name: Move to Review
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      github.event.action == 'ready_for_review' &&
      !github.event.pull_request.draft
    steps:
      - name: Get PR project item ID
        id: get_item
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              repository(owner: $owner, name: "shooting-star") {
                pullRequest(number: $number) {
                  projectItems(first: 10) {
                    nodes {
                      id
                      project {
                        id
                      }
                    }
                  }
                }
              }
            }' -f owner=flavius-atticae -F number=${{ github.event.pull_request.number }} \
            --jq '.data.repository.pullRequest.projectItems.nodes[] | select(.project.id == "'${{ env.PROJECT_ID }}'") | .id')
          
          if [ -z "$ITEM_ID" ]; then
            # Add PR to project first
            ITEM_ID=$(gh api graphql -f query='
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                  item {
                    id
                  }
                }
              }' -f projectId=${{ env.PROJECT_ID }} -f contentId=${{ github.event.pull_request.node_id }} \
              --jq '.data.addProjectV2ItemById.item.id')
          fi
          
          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT

      - name: Move PR to Review
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: {singleSelectOptionId: $optionId}
              }) {
                projectV2Item {
                  id
                }
              }
            }' -f projectId=${{ env.PROJECT_ID }} \
               -f itemId=${{ steps.get_item.outputs.item_id }} \
               -f fieldId=${{ env.STATUS_FIELD_ID }} \
               -f optionId=${{ env.REVIEW_ID }}

  move-to-testing:
    name: Move to Testing
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request_review' && 
      github.event.review.state == 'approved'
    steps:
      - name: Check if all reviews are approved
        id: check_reviews
        run: |
          # Get PR reviews
          REVIEWS=$(curl -s -H "Authorization: token ${{ secrets.PROJECT_PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews")
          
          # Check if there are any requested changes
          REQUESTED_CHANGES=$(echo "$REVIEWS" | jq '[.[] | select(.state == "CHANGES_REQUESTED")] | length')
          APPROVED=$(echo "$REVIEWS" | jq '[.[] | select(.state == "APPROVED")] | length')
          
          if [ "$REQUESTED_CHANGES" -eq 0 ] && [ "$APPROVED" -gt 0 ]; then
            echo "approved=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Get PR project item ID
        id: get_item
        if: steps.check_reviews.outputs.approved == 'true'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              repository(owner: $owner, name: "shooting-star") {
                pullRequest(number: $number) {
                  projectItems(first: 10) {
                    nodes {
                      id
                      project {
                        id
                      }
                    }
                  }
                }
              }
            }' -f owner=flavius-atticae -F number=${{ github.event.pull_request.number }} \
            --jq '.data.repository.pullRequest.projectItems.nodes[] | select(.project.id == "'${{ env.PROJECT_ID }}'") | .id')
          
          if [ -z "$ITEM_ID" ]; then
            # Add PR to project first
            ITEM_ID=$(gh api graphql -f query='
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                  item {
                    id
                  }
                }
              }' -f projectId=${{ env.PROJECT_ID }} -f contentId=${{ github.event.pull_request.node_id }} \
              --jq '.data.addProjectV2ItemById.item.id')
          fi
          
          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT

      - name: Move PR to Testing
        if: steps.check_reviews.outputs.approved == 'true' && steps.get_item.outputs.item_id
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: {singleSelectOptionId: $optionId}
              }) {
                projectV2Item {
                  id
                }
              }
            }' -f projectId=${{ env.PROJECT_ID }} \
               -f itemId=${{ steps.get_item.outputs.item_id }} \
               -f fieldId=${{ env.STATUS_FIELD_ID }} \
               -f optionId=${{ env.TESTING_ID }}

  move-to-done:
    name: Move to Done
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true) ||
      (github.event_name == 'issues' && github.event.action == 'closed')
    steps:
      - name: Get item project ID
        id: get_item
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            ITEM_ID=$(gh api graphql -f query='
              query($owner: String!, $number: Int!) {
                repository(owner: $owner, name: "shooting-star") {
                  pullRequest(number: $number) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                      }
                    }
                  }
                }
              }' -f owner=flavius-atticae -F number=${{ github.event.pull_request.number }} \
              --jq '.data.repository.pullRequest.projectItems.nodes[] | select(.project.id == "'${{ env.PROJECT_ID }}'") | .id')
          else
            ITEM_ID=$(gh api graphql -f query='
              query($owner: String!, $number: Int!) {
                repository(owner: $owner, name: "shooting-star") {
                  issue(number: $number) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                        }
                      }
                    }
                  }
                }
              }' -f owner=flavius-atticae -F number=${{ github.event.issue.number }} \
              --jq '.data.repository.issue.projectItems.nodes[] | select(.project.id == "'${{ env.PROJECT_ID }}'") | .id')
          fi
          
          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT

      - name: Move to Done
        if: steps.get_item.outputs.item_id
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: {singleSelectOptionId: $optionId}
              }) {
                projectV2Item {
                  id
                }
              }
            }' -f projectId=${{ env.PROJECT_ID }} \
               -f itemId=${{ steps.get_item.outputs.item_id }} \
               -f fieldId=${{ env.STATUS_FIELD_ID }} \
               -f optionId=${{ env.DONE_ID }}

  move-to-released:
    name: Move to Released
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    steps:
      - name: Get issues from release
        id: release_issues
        run: |
          # Extract issue numbers from release body and commits
          RELEASE_BODY="${{ github.event.release.body }}"
          ISSUES=$(echo "$RELEASE_BODY" | grep -oE '#[0-9]+' | cut -d'#' -f2 | sort -u)
          echo "issues<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Move issues to Released
        if: steps.release_issues.outputs.issues
        run: |
          for issue in ${{ steps.release_issues.outputs.issues }}; do
            curl -X POST \
              -H "Authorization: token ${{ secrets.PROJECT_PAT }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$issue/comments" \
              -d "{\"body\":\"This issue has been released in version ${{ github.event.release.tag_name }}\"}"
          done

  quality-gates:
    name: Quality Gates Check
    runs-on: ubuntu-latest
    if: github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success'
    steps:
      - name: Check if all CI checks passed
        id: ci_status
        run: |
          # Get the PR associated with this check suite
          PR_NUMBER=$(curl -s -H "Authorization: token ${{ secrets.PROJECT_PAT }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.event.check_suite.head_branch }}" | \
            jq '.[0].number')
          
          if [ "$PR_NUMBER" != "null" ]; then
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "ready_for_testing=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Get PR project item ID
        id: get_item
        if: steps.ci_status.outputs.ready_for_testing == 'true'
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          ITEM_ID=$(gh api graphql -f query='
            query($owner: String!, $number: Int!) {
              repository(owner: $owner, name: "shooting-star") {
                pullRequest(number: $number) {
                  projectItems(first: 10) {
                    nodes {
                      id
                      project {
                        id
                      }
                    }
                  }
                }
              }
            }' -f owner=flavius-atticae -F number=${{ steps.ci_status.outputs.pr_number }} \
            --jq '.data.repository.pullRequest.projectItems.nodes[] | select(.project.id == "'${{ env.PROJECT_ID }}'") | .id')
          
          if [ -z "$ITEM_ID" ]; then
            # Get PR node_id first
            PR_NODE_ID=$(gh api repos/flavius-atticae/shooting-star/pulls/${{ steps.ci_status.outputs.pr_number }} --jq .node_id)
            # Add PR to project first
            ITEM_ID=$(gh api graphql -f query='
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                  item {
                    id
                  }
                }
              }' -f projectId=${{ env.PROJECT_ID }} -f contentId=$PR_NODE_ID \
              --jq '.data.addProjectV2ItemById.item.id')
          fi
          
          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT

      - name: Move to Testing after CI success
        if: steps.ci_status.outputs.ready_for_testing == 'true' && steps.get_item.outputs.item_id
        env:
          GH_TOKEN: ${{ secrets.PROJECT_PAT }}
        run: |
          gh api graphql -f query='
            mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $projectId
                itemId: $itemId
                fieldId: $fieldId
                value: {singleSelectOptionId: $optionId}
              }) {
                projectV2Item {
                  id
                }
              }
            }' -f projectId=${{ env.PROJECT_ID }} \
               -f itemId=${{ steps.get_item.outputs.item_id }} \
               -f fieldId=${{ env.STATUS_FIELD_ID }} \
               -f optionId=${{ env.TESTING_ID }}