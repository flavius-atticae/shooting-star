name: PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type checking
        run: npm run typecheck
        continue-on-error: false
      
      - name: Build check
        run: npm run build
        continue-on-error: false
      
      - name: Test coverage check
        run: |
          npm run test:coverage
          # Check if coverage meets pregnancy-safe healthcare thresholds
          COVERAGE_SUMMARY=$(cat coverage/coverage-final.json | jq -r '.total | "Lines: \(.lines.pct)% | Branches: \(.branches.pct)% | Functions: \(.functions.pct)% | Statements: \(.statements.pct)%"')
          echo "Coverage Summary: $COVERAGE_SUMMARY"
          
          # Validate against Quebec healthcare standards (85% lines, 80% branches/functions)
          LINES_PCT=$(cat coverage/coverage-final.json | jq '.total.lines.pct')
          BRANCHES_PCT=$(cat coverage/coverage-final.json | jq '.total.branches.pct')
          
          if (( $(echo "$LINES_PCT < 85" | bc -l) )) || (( $(echo "$BRANCHES_PCT < 80" | bc -l) )); then
            echo "Coverage below Quebec healthcare standards (Lines: 85%, Branches: 80%)"
            echo "Current: Lines: $LINES_PCT%, Branches: $BRANCHES_PCT%"
            exit 1
          fi
        continue-on-error: false
      
      - name: Update PR status
        if: success()
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d '{
              "body": "‚úÖ **Quality Gates Passed**\n\n- Type checking: ‚úÖ\n- Build: ‚úÖ\n- Test coverage: ‚úÖ (Quebec healthcare standards met)\n\nThis PR is ready for code review!"
            }'

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run security audit
        run: |
          npm audit --audit-level high
        continue-on-error: true
      
      - name: Check for sensitive files
        run: |
          # Check for common sensitive files
          SENSITIVE_FILES=$(find . -name "*.env*" -o -name "*.key" -o -name "*.pem" -o -name "config.json" | grep -v node_modules || true)
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "Warning: Potential sensitive files found:"
            echo "$SENSITIVE_FILES"
            exit 1
          fi

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build for production
        run: npm run build
      
      - name: Check bundle size
        run: |
          # Simple bundle size check - you can enhance this with more sophisticated tools
          BUILD_SIZE=$(du -sh build/ | cut -f1)
          echo "Build size: $BUILD_SIZE"
          
          # Add comment to PR with build size
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d "{
              \"body\": \"üìä **Performance Report**\\n\\nBuild size: \`$BUILD_SIZE\`\\n\\n_Automated performance check completed._\"
            }"

  accessibility-check:
    name: Accessibility Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          # Install accessibility testing tools
          npm install --no-save @axe-core/cli pa11y
      
      - name: Build application
        run: npm run build
      
      - name: Start application
        run: |
          npm start &
          # Wait for application to start
          sleep 10
        timeout-minutes: 2
      
      - name: Run accessibility tests
        run: |
          # Run axe-core accessibility tests
          npx axe http://localhost:3000 --save accessibility-report.json || true
          
          # Check if report exists and has violations
          if [ -f accessibility-report.json ]; then
            VIOLATIONS=$(jq '.[0].violations | length' accessibility-report.json)
            if [ "$VIOLATIONS" -gt 0 ]; then
              echo "Accessibility violations found: $VIOLATIONS"
              # Post summary to PR
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
                -d "{
                  \"body\": \"‚ö†Ô∏è **Accessibility Check**\\n\\n$VIOLATIONS accessibility violations found. Please review and fix before merging.\"
                }"
            else
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
                -d '{
                  "body": "‚úÖ **Accessibility Check Passed**\n\nNo accessibility violations found!"
                }'
            fi
          fi

  integration-ready:
    name: Integration Ready Check
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, performance-check, accessibility-check]
    if: github.event_name == 'pull_request' && always()
    steps:
      - name: Check all quality gates
        run: |
          if [[ "${{ needs.code-quality.result }}" == "success" && 
                "${{ needs.security-scan.result }}" == "success" && 
                "${{ needs.performance-check.result }}" == "success" && 
                "${{ needs.accessibility-check.result }}" == "success" ]]; then
            echo "All quality gates passed"
            
            # Mark PR as ready for review
            curl -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" \
              -d '{"draft": false}'
            
            # Add success comment
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
              -d '{
                "body": "üéâ **All Quality Gates Passed!**\n\nThis PR is now ready for review and has been marked as non-draft.\n\n‚úÖ Code Quality\n‚úÖ Security Scan\n‚úÖ Performance Check\n‚úÖ Accessibility Check"
              }'
          else
            echo "Some quality gates failed"
            
            # Mark PR as draft
            curl -X PATCH \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" \
              -d '{"draft": true}'
            
            # Remove Testing label if it exists
            curl -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels/Testing" 2>/dev/null || true
            
            # Add appropriate quality labels based on failed checks
            QUALITY_LABELS=""
            if [[ "${{ needs.code-quality.result }}" != "success" ]]; then
              QUALITY_LABELS+='"Code Quality",'
            fi
            if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
              QUALITY_LABELS+='"Security",'
            fi
            if [[ "${{ needs.performance-check.result }}" != "success" ]]; then
              QUALITY_LABELS+='"Performance",'
            fi
            if [[ "${{ needs.accessibility-check.result }}" != "success" ]]; then
              QUALITY_LABELS+='"Accessibility",'
            fi
            
            # Remove trailing comma and add labels if any failed
            if [[ -n "$QUALITY_LABELS" ]]; then
              QUALITY_LABELS=${QUALITY_LABELS%,}
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels" \
                -d "{\"labels\":[$QUALITY_LABELS]}"
            fi
            
            # Add failure comment with details
            FAILED_JOBS=""
            if [[ "${{ needs.code-quality.result }}" != "success" ]]; then
              FAILED_JOBS+="‚ùå Code Quality\\n"
            else
              FAILED_JOBS+="‚úÖ Code Quality\\n"
            fi
            if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
              FAILED_JOBS+="‚ùå Security Scan\\n"
            else
              FAILED_JOBS+="‚úÖ Security Scan\\n"
            fi
            if [[ "${{ needs.performance-check.result }}" != "success" ]]; then
              FAILED_JOBS+="‚ùå Performance Check\\n"
            else
              FAILED_JOBS+="‚úÖ Performance Check\\n"
            fi
            if [[ "${{ needs.accessibility-check.result }}" != "success" ]]; then
              FAILED_JOBS+="‚ùå Accessibility Check\\n"
            else
              FAILED_JOBS+="‚úÖ Accessibility Check\\n"
            fi
            
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
              -d "{
                \"body\": \"‚ö†Ô∏è **Quality Gates Failed**\\n\\nThis PR has been marked as draft until all checks pass.\\n\\n${FAILED_JOBS}\\nPlease fix the failing checks and push new commits to re-run the validation.\"
              }"
          fi