name: Deploy to Fly.io

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - rollback
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      rollback_target:
        description: 'Rollback target (release version or Docker image tag)'
        required: false
        type: string

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.operation == 'deploy' && github.event.inputs.environment == 'staging')
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@63da3ecc5e2793b98a3f2519b3d75d4f4c11cec2
      
      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          flyctl deploy --app ${{ vars.FLYIO_STAGING_APP_NAME }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Notify deployment
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments" \
            -d '{
              "body": "üöÄ **Staging Deployment Successful**\n\nThe latest changes have been deployed to staging environment.\n\n**Environment**: Staging\n**Commit**: ${{ github.sha }}\n**Deployment Time**: ${{ github.event.head_commit.timestamp }}"
            }'

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.operation == 'deploy' && github.event.inputs.environment == 'production')
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@63da3ecc5e2793b98a3f2519b3d75d4f4c11cec2
      
      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          flyctl deploy --app ${{ vars.FLYIO_PRODUCTION_APP_NAME }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      
      - name: Create deployment record
        run: |
          # Record deployment details
          DEPLOYMENT_INFO='{
            "environment": "production",
            "version": "${{ github.event.release.tag_name || github.sha }}",
            "deployed_by": "${{ github.actor }}",
            "deployed_at": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'",
            "commit_sha": "${{ github.sha }}"
          }'
          echo "Deployment info: $DEPLOYMENT_INFO"
      
      - name: Log release deployment
        if: github.event_name == 'release'
        run: |
          echo "Production deployment completed for release: ${{ github.event.release.tag_name }}"
          echo "Release notes: ${{ github.event.release.body }}"

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.operation == 'rollback'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@63da3ecc5e2793b98a3f2519b3d75d4f4c11cec2
      
      - name: Get current releases
        id: releases
        run: |
          # Set app name based on environment
          if [[ "$INPUT_ENVIRONMENT" == "production" ]]; then
            APP_NAME="$FLYIO_PRODUCTION_APP_NAME"
          else
            APP_NAME="$FLYIO_STAGING_APP_NAME"
          fi
          
          echo "Getting releases for app: $APP_NAME"
          flyctl releases --app $APP_NAME --image -j > releases.json
          
          # Display available releases for debugging
          echo "Available releases:"
          cat releases.json | jq -r '.[] | select(.status == "succeeded") | "\(.version): \(.image // "No image")"' | head -10
          
          # Get the most recent successful release if no specific target provided
          if [[ -z "$INPUT_ROLLBACK_TARGET" ]]; then
            LATEST_IMAGE=$(cat releases.json | jq -r '.[] | select(.status == "succeeded") | .image' | head -2 | tail -1)
            echo "rollback_image=$LATEST_IMAGE" >> $GITHUB_OUTPUT
            echo "Using latest successful release image: $LATEST_IMAGE"
          else
            # Check if rollback_target is an image or version
            if [[ "$INPUT_ROLLBACK_TARGET" =~ ^registry\.fly\.io ]]; then
              echo "rollback_image=$INPUT_ROLLBACK_TARGET" >> $GITHUB_OUTPUT
              echo "Using specified image: $INPUT_ROLLBACK_TARGET"
            else
              # Try to find image by version
              TARGET_IMAGE=$(cat releases.json | jq -r --arg version "$INPUT_ROLLBACK_TARGET" '.[] | select(.version == $version) | .image')
              if [[ -n "$TARGET_IMAGE" && "$TARGET_IMAGE" != "null" ]]; then
                echo "rollback_image=$TARGET_IMAGE" >> $GITHUB_OUTPUT
                echo "Found image for version $INPUT_ROLLBACK_TARGET: $TARGET_IMAGE"
              else
                echo "Could not find image for version: $INPUT_ROLLBACK_TARGET"
                exit 1
              fi
            fi
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          INPUT_ENVIRONMENT: ${{ github.event.inputs.environment }}
          INPUT_ROLLBACK_TARGET: ${{ github.event.inputs.rollback_target }}
          FLYIO_PRODUCTION_APP_NAME: ${{ vars.FLYIO_PRODUCTION_APP_NAME }}
          FLYIO_STAGING_APP_NAME: ${{ vars.FLYIO_STAGING_APP_NAME }}
      
      - name: Validate rollback target
        run: |
          if [[ -z "$ROLLBACK_IMAGE" || "$ROLLBACK_IMAGE" == "null" ]]; then
            echo "Error: No valid rollback image found"
            echo "Please check available releases and specify a valid target"
            exit 1
          fi
          echo "Validated rollback target: $ROLLBACK_IMAGE"
        env:
          ROLLBACK_IMAGE: ${{ steps.releases.outputs.rollback_image }}
      
      - name: Perform rollback deployment
        run: |
          # Set app name based on environment
          if [[ "$INPUT_ENVIRONMENT" == "production" ]]; then
            APP_NAME="$FLYIO_PRODUCTION_APP_NAME"
          else
            APP_NAME="$FLYIO_STAGING_APP_NAME"
          fi
          
          echo "Rolling back $INPUT_ENVIRONMENT environment..."
          echo "App: $APP_NAME"
          echo "Target image: $ROLLBACK_IMAGE"
          
          # Deploy the specific image (this is the correct way to rollback in Fly.io)
          flyctl deploy --image "$ROLLBACK_IMAGE" --app "$APP_NAME"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          INPUT_ENVIRONMENT: ${{ github.event.inputs.environment }}
          FLYIO_PRODUCTION_APP_NAME: ${{ vars.FLYIO_PRODUCTION_APP_NAME }}
          FLYIO_STAGING_APP_NAME: ${{ vars.FLYIO_STAGING_APP_NAME }}
          ROLLBACK_IMAGE: ${{ steps.releases.outputs.rollback_image }}
      
      - name: Verify rollback
        run: |
          # Set app name based on environment
          if [[ "$INPUT_ENVIRONMENT" == "production" ]]; then
            APP_NAME="$FLYIO_PRODUCTION_APP_NAME"
          else
            APP_NAME="$FLYIO_STAGING_APP_NAME"
          fi
          
          echo "Verifying rollback deployment..."
          sleep 10
          
          # Get current release info
          flyctl releases --app "$APP_NAME" -j | jq -r '.[0] | "Current release: \(.version) - Status: \(.status)"'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          INPUT_ENVIRONMENT: ${{ github.event.inputs.environment }}
          FLYIO_PRODUCTION_APP_NAME: ${{ vars.FLYIO_PRODUCTION_APP_NAME }}
          FLYIO_STAGING_APP_NAME: ${{ vars.FLYIO_STAGING_APP_NAME }}
      
      - name: Notify rollback
        run: |
          # Set environment-specific variables
          if [[ "$INPUT_ENVIRONMENT" == "production" ]]; then
            ENV_EMOJI="üö®"
            ENV_NAME="Production"
          else
            ENV_EMOJI="üß™"
            ENV_NAME="Staging"
          fi
          
          # Set rollback target display text
          if [[ -z "$INPUT_ROLLBACK_TARGET" ]]; then
            ROLLBACK_TARGET_DISPLAY="Previous successful release"
          else
            ROLLBACK_TARGET_DISPLAY="$INPUT_ROLLBACK_TARGET"
          fi
          
          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/comments" \
            -d "{
              \"body\": \"$ENV_EMOJI **Rollback Completed**\\n\\n$ENV_NAME deployment has been rolled back successfully.\\n\\n**Environment**: $INPUT_ENVIRONMENT\\n**Target**: $ROLLBACK_TARGET_DISPLAY\\n**Triggered by**: $GITHUB_ACTOR\\n**Image**: \\\`$ROLLBACK_IMAGE\\\`\"
            }"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
          INPUT_ENVIRONMENT: ${{ github.event.inputs.environment }}
          INPUT_ROLLBACK_TARGET: ${{ github.event.inputs.rollback_target }}
          ROLLBACK_IMAGE: ${{ steps.releases.outputs.rollback_image }}

  health-check:
    name: Post-Deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production, rollback]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success' || needs.rollback.result == 'success')
    steps:
      - name: Wait for deployment to stabilize
        run: sleep 30
      
      - name: Check application health
        run: |
          # Determine environment and health URL based on which job succeeded
          if [[ "$DEPLOY_PROD_RESULT" == "success" ]]; then
            ENVIRONMENT="production"
            HEALTH_URL="$PRODUCTION_HEALTH_URL"
          elif [[ "$ROLLBACK_RESULT" == "success" ]]; then
            # For rollback, check the environment that was rolled back
            if [[ "$INPUT_ENVIRONMENT" == "production" ]]; then
              ENVIRONMENT="production"
              HEALTH_URL="$PRODUCTION_HEALTH_URL"
            else
              ENVIRONMENT="staging"
              HEALTH_URL="$STAGING_HEALTH_URL"
            fi
          else
            ENVIRONMENT="staging"
            HEALTH_URL="$STAGING_HEALTH_URL"
          fi
          
          echo "Checking health of $ENVIRONMENT environment"
          
          # Perform health check with retries
          RETRY_COUNT=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $RETRY_COUNT); do
            echo "Health check attempt $i/$RETRY_COUNT"
            if curl -f -s --max-time 10 "$HEALTH_URL"; then
              echo "Health check passed for $ENVIRONMENT"
              exit 0
            else
              echo "Health check attempt $i failed, retrying in ${RETRY_DELAY}s..."
              if [ $i -lt $RETRY_COUNT ]; then
                sleep $RETRY_DELAY
              fi
            fi
          done
          
          echo "Health check failed after $RETRY_COUNT attempts"
          exit 1
        env:
          DEPLOY_PROD_RESULT: ${{ needs.deploy-production.result }}
          ROLLBACK_RESULT: ${{ needs.rollback.result }}
          INPUT_ENVIRONMENT: ${{ github.event.inputs.environment }}
          PRODUCTION_HEALTH_URL: ${{ vars.PRODUCTION_HEALTH_URL }}
          STAGING_HEALTH_URL: ${{ vars.STAGING_HEALTH_URL }}
      
      - name: Report health status
        if: success()
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments" \
            -d '{
              "body": "‚úÖ **Health Check Passed**\n\nPost-deployment health check completed successfully.\n\nAll systems are operational."
            }'
      
      - name: Report health failure
        if: failure()
        run: |
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/comments" \
            -d '{
              "body": "‚ùå **Health Check Failed**\n\nPost-deployment health check failed. Please investigate immediately.\n\n**Action Required**: Manual intervention needed."
            }'