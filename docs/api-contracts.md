# API Contracts

> Auto-generated by Document Project workflow on 2026-02-13.
> Mode: initial_scan | Scan Level: exhaustive

## Overview

Shooting Star is a server-side rendered web application using React Router v7. It exposes server-side functionality via **route loaders** (GET) and **route actions** (POST). There are no traditional REST API endpoints — all server interactions use React Router's built-in form handling with progressive enhancement.

## Server Endpoints

### Route Loaders (Data Loading)

| Route  | Path             | Loader                  | Description                                              |
| ------ | ---------------- | ----------------------- | -------------------------------------------------------- |
| Root   | `*` (all routes) | `root.tsx → loader()`   | Returns honeypot input props for anti-spam protection    |
| Health | `/health`        | `health.tsx → loader()` | JSON health check: `{ status: "ok", timestamp, uptime }` |

#### Root Loader

```typescript
// app/root.tsx
export async function loader() {
  const honeypotInputProps = await honeypot.getInputProps();
  return { honeypotInputProps };
}
```

- **Purpose**: Provides honeypot form protection props to all routes
- **Response**: `{ honeypotInputProps: HoneypotInputProps }`
- **Used by**: `HoneypotProvider` wrapping all routes in the root `App` component

#### Health Check Loader

```typescript
// app/routes/health.tsx
export async function loader() {
  return Response.json({
    status: "ok",
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
  });
}
```

- **Purpose**: Monitoring endpoint for Fly.io health checks
- **Response**: `{ status: "ok", timestamp: string, uptime: number }`
- **Consumers**: Fly.io HTTP service checks (every 30s, 5s grace period)

### Route Actions (Form Submissions)

| Route   | Path       | Method | Action                   | Description                      |
| ------- | ---------- | ------ | ------------------------ | -------------------------------- |
| Contact | `/contact` | POST   | `contact.tsx → action()` | Process contact form submissions |

#### Contact Form Action

```typescript
// app/routes/contact.tsx
export async function action({ request }: Route.ActionArgs) {
  const formData = await request.formData();
  // 1. Honeypot validation (spam check)
  // 2. Rate limiting (3 req/15min per IP)
  // 3. Zod schema validation (name, email, availability?, message)
  // 4. Input sanitization (HTML tag stripping)
  // 5. Send emails via Resend API (confirmation + notification)
  return data({ success: true, message: "..." });
}
```

**Request Flow:**

```
Client Form Submission (POST /contact)
    │
    ├── 1. Honeypot Check ──── Fail → 400 "Form submission rejected"
    │
    ├── 2. Rate Limit Check ── Fail → 429 "Trop de messages envoyés"
    │
    ├── 3. Zod Validation ──── Fail → 400 { errors: fieldErrors }
    │
    ├── 4. Input Sanitization
    │
    ├── 5. Send Emails (Promise.allSettled)
    │   ├── Confirmation → contact submitter
    │   └── Notification → Pauline Roussel
    │
    └── Success → 200 { success: true, message: "..." }
```

**Request Body (FormData):**

| Field           | Type   | Required | Validation                    |
| --------------- | ------ | -------- | ----------------------------- |
| `name`          | string | ✅       | 2-100 chars, sanitized        |
| `email`         | string | ✅       | Valid email format            |
| `availability`  | string | ❌       | Optional time slot preference |
| `message`       | string | ✅       | 10-2000 chars, sanitized      |
| Honeypot fields | hidden | ✅       | Must be empty (bot trap)      |

**Response Codes:**

| Code | Condition          | Body                                                         |
| ---- | ------------------ | ------------------------------------------------------------ |
| 200  | Success            | `{ success: true, message: "Merci pour votre message..." }`  |
| 400  | Honeypot triggered | `{ success: false, message: "Form submission rejected" }`    |
| 400  | Validation failed  | `{ success: false, errors: { fieldName: string[] } }`        |
| 429  | Rate limited       | `{ success: false, message: "Trop de messages envoyés..." }` |
| 500  | Email send failure | `{ success: false, message: "Une erreur est survenue..." }`  |

## Server-Only Modules

### Email Service (`app/lib/email.server.ts`)

- **Provider**: Resend API
- **Functions**:
  - `sendContactConfirmation(data)` — Sends confirmation to form submitter
  - `sendContactNotification(data)` — Sends notification to Pauline (site owner)
  - `sendContactEmails(data)` — Orchestrates both emails via `Promise.allSettled`
- **Retry**: 1 retry on failure per email
- **Templates**: React Email components (`app/emails/`)

### Rate Limiter (`app/lib/rate-limiter.ts`)

- **Strategy**: In-memory Map keyed by IP address
- **Limits**: 3 requests per 15-minute window
- **Cleanup**: Auto-cleanup of expired entries every 5 minutes
- **Functions**: `isRateLimited(ip)`, `resetRateLimiter()`

### Honeypot (`app/lib/honeypot.server.ts`)

- **Library**: remix-utils Honeypot
- **Configuration**: Encrypted seed from `HONEYPOT_ENCRYPTION_SEED` env var
- **Fallback**: Dev environment uses hardcoded seed

## Environment Variables

| Variable                   | Required  | Description                         |
| -------------------------- | --------- | ----------------------------------- |
| `RESEND_API_KEY`           | ✅        | Resend API authentication key       |
| `RESEND_FROM_EMAIL`        | ✅        | Sender email address                |
| `RESEND_FROM_NAME`         | ❌        | Sender display name                 |
| `CONTACT_REPLY_TO`         | ❌        | Reply-to address for contact emails |
| `HONEYPOT_ENCRYPTION_SEED` | ✅ (prod) | Encryption seed for honeypot fields |

## Client-Server Data Flow

```
Browser                     Server (SSR)
  │                            │
  │── GET /contact ──────────→ │ loader() → honeypotInputProps
  │←── HTML + hydration ──────│
  │                            │
  │── POST /contact ─────────→ │ action() → validate → email → response
  │←── JSON { success } ──────│
  │                            │
  │── useFetcher revalidate ─→ │ (React Router handles revalidation)
  │←── Updated UI ────────────│
```
