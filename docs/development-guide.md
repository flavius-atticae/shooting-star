# Development Guide

> Auto-generated by Document Project workflow on 2026-02-13.
> Mode: initial_scan | Scan Level: exhaustive

## Prerequisites

| Requirement | Version           | Notes                                        |
| ----------- | ----------------- | -------------------------------------------- |
| **Node.js** | 22+               | LTS recommended (Dev Container uses Node 22) |
| **npm**     | Bundled with Node | For dependency management                    |
| **Docker**  | Optional          | For Dev Container or production builds       |
| **VS Code** | Latest            | Recommended IDE with Dev Container support   |

## Quick Start

```bash
# Clone the repository
git clone https://github.com/flavius-atticae/shooting-star.git
cd shooting-star

# Install dependencies
npm install

# Start development server (SSR, port 5173)
npm run dev

# In a separate terminal, start Storybook (port 6006)
npm run storybook
```

## Dev Container Setup (Recommended)

The project includes a Dev Container configuration for consistent development environments:

**VS Code + Docker:**

1. Install the "Dev Containers" extension
2. Open the project folder
3. Click "Reopen in Container" when prompted
4. Dependencies and Playwright install automatically via `postCreateCommand`

**GitHub Codespaces:**

1. Navigate to the repository on GitHub
2. Click "Code" → "Codespaces" → "Create codespace on main"
3. Environment is ready automatically

### Dev Container Features

| Feature             | Details                                                                                 |
| ------------------- | --------------------------------------------------------------------------------------- |
| **Base Image**      | `mcr.microsoft.com/devcontainers/javascript-node:22`                                    |
| **GitHub CLI**      | Pre-installed via features                                                              |
| **Forwarded Ports** | 5173 (Vite), 6006 (Storybook)                                                           |
| **Post-create**     | `npm install && npx playwright install --with-deps chromium && npx bmad-method install` |

### Pre-installed VS Code Extensions

| Extension                 | Purpose                     |
| ------------------------- | --------------------------- |
| Tailwind CSS IntelliSense | Tailwind class autocomplete |
| ESLint                    | Code linting                |
| Prettier                  | Code formatting             |
| MDX                       | MDX file support            |
| GitHub Copilot + Chat     | AI assistance               |
| GitHub Actions            | Workflow visualization      |
| GitHub Pull Requests      | PR management               |
| npm Intellisense          | Package autocomplete        |
| Pretty TypeScript Errors  | Better TS error display     |
| Night Owl                 | Color theme                 |
| Codacy                    | Code quality integration    |

## npm Scripts

| Script            | Command                                      | Description                                   |
| ----------------- | -------------------------------------------- | --------------------------------------------- |
| `dev`             | `react-router dev`                           | Start development server with SSR (port 5173) |
| `build`           | `react-router build`                         | Production build                              |
| `start`           | `react-router-serve ./build/server/index.js` | Serve production build                        |
| `typecheck`       | `react-router typegen && tsc`                | Generate types + TypeScript check             |
| `test`            | `vitest run`                                 | Run unit tests (single run)                   |
| `test:watch`      | `vitest`                                     | Run unit tests in watch mode                  |
| `test:ui`         | `vitest --ui`                                | Run tests with Vitest UI                      |
| `test:e2e`        | `playwright test`                            | Run E2E tests                                 |
| `test:e2e:ui`     | `playwright test --ui`                       | Run E2E tests with Playwright UI              |
| `test:e2e:headed` | `playwright test --headed`                   | Run E2E tests in headed browser               |
| `test:e2e:debug`  | `playwright test --debug`                    | Debug E2E tests                               |
| `test:e2e:report` | `playwright show-report`                     | Open E2E test report                          |
| `test:all`        | `npm run test && npm run test:e2e`           | Run all tests                                 |
| `storybook`       | `storybook dev -p 6006 --no-open`            | Start Storybook dev server                    |
| `build-storybook` | `storybook build`                            | Build static Storybook                        |
| `chromatic`       | `chromatic --exit-zero-on-changes`           | Run Chromatic visual regression               |

## Environment Variables

Copy `.env.example` to `.env` and configure:

```bash
# Email (Resend API for contact form)
RESEND_API_KEY=re_your_api_key
RESEND_FROM_EMAIL=contact@yourdomain.com
RESEND_FROM_NAME="Pauline Roussel"
CONTACT_REPLY_TO=pauline@yourdomain.com

# Security
HONEYPOT_ENCRYPTION_SEED=your-random-seed-here
```

| Variable                   | Required   | Default      | Description                             |
| -------------------------- | ---------- | ------------ | --------------------------------------- |
| `RESEND_API_KEY`           | Production | —            | Resend API key for transactional emails |
| `RESEND_FROM_EMAIL`        | Production | —            | Sender email address                    |
| `RESEND_FROM_NAME`         | No         | —            | Sender display name                     |
| `CONTACT_REPLY_TO`         | No         | —            | Reply-to address                        |
| `HONEYPOT_ENCRYPTION_SEED` | Production | Dev fallback | Encryption seed for honeypot fields     |

## Development Workflow

### Git Branching

```
main (protected)
  ├── feature/issue-012-prenatal-yoga-page
  ├── feature/issue-023-postnatal-yoga-page
  └── fix/issue-034-contact-form-validation
```

- **Never** work directly on `main`
- Branch naming: `feature/issue-<number>-<description>` or `fix/issue-<number>-<description>`
- All PRs target `main`

### Commit Messages

```
[ #12 ] Add prenatal yoga page
[ #23 ] Implement postnatal yoga section
[ #34 ] Fix contact form validation
```

### PR Description Structure

1. **Context** — Problem or feature addressed
2. **Main changes** — Bullet list of key changes
3. **Accessibility impact** — WCAG 2.1 AA compliance
4. **Performance impact** — Bundle size, LCP
5. **Compliance impact** — GDPR/PIPEDA/Law 25

## Testing Strategy

### Test Pyramid Responsibilities (Canonical)

Each test must have one primary pyramid level. Scope must not overlap by default.

### Operational Convention (Kent-aligned)

For implementation and PR review, use three primary functional levels:

- `component-unit`: combines isolated logic and local component behavior.
- `integration`: validates route/module composition and framework contracts.
- `e2e`: validates browser-level critical journeys.

`visual` remains a required baseline-governance lane (Storybook/Chromatic) and must be explicitly tracked in PRs when changed.

| Level            | Primary risk covered                                          | In-scope                                                                                                              | Out-of-scope                                                                                         | Owner                          | Expected artifact                                                 | Good fit example                                                                    | Anti-pattern example                                                |
| ---------------- | ------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- | ------------------------------ | ----------------------------------------------------------------- | ----------------------------------------------------------------------------------- | ------------------------------------------------------------------- |
| `component-unit` | Local UI and isolated logic regressions                       | Deterministic utility logic, hooks, server-safe validators, component behavior, accessibility semantics, event wiring | Full route orchestration, cross-route browser journeys, visual baseline governance                   | Feature author                 | `app/test/lib/**/*.test.ts` + `app/test/components/**/*.test.tsx` | Validate form validator branch and corresponding component error rendering behavior | Re-asserting full multi-page submission flow already covered by e2e |
| `integration`    | Contract breakage between route modules and framework context | React Router SSR route rendering, loader/action composition, route-level data wiring                                  | Pixel layout, cross-browser behavior, exhaustive edge-branch checks better handled in component-unit | Feature author                 | `app/test/integration/**/*-route.test.tsx`                        | Validate route-level rendering and fallback state wiring for a route                | Duplicating browser navigation assertions across multiple pages     |
| `e2e`            | Real-user journey and browser-runtime integration risk        | Critical paths across routes, browser APIs, navigation, form submission flow, CI smoke for production-like behavior   | Internal branch-by-branch logic already validated lower in stack, visual baseline ownership          | QA + feature author            | `app/test/e2e/specs/**/*.spec.ts`                                 | Validate contact journey from page load to successful submission and error recovery | Asserting every internal utility branch via browser steps           |
| `visual`         | Unintended visual drift and design regression                 | Stable UI snapshots and deterministic visual baselines for key states/components                                      | Functional logic coverage, business-rule branching, route contract validation                        | Design system + feature author | Storybook/Chromatic visual baselines and review artifacts         | Snapshot baseline for key component states (default/error/disabled)                 | Using visual diffs as proof that form validation logic is correct   |

### Anti-Overlap Governance

- One assertion = one primary level.
- Do not duplicate assertions across levels unless an exception is documented.
- Allowed overlap example: E2E validates journey completion while component-unit validates validator edge branches.
- Prohibited duplication example: same validation branch asserted in component-unit, integration, and e2e with identical expected outcome.

### Exception Protocol (Required for Intentional Overlap)

If overlap is intentional, add a short exception entry in the PR description:

```text
Test overlap exception:
- assertion: <what is duplicated>
- primary level: <component-unit|integration|e2e|visual>
- secondary level: <component-unit|integration|e2e|visual>
- reason: <risk that cannot be covered well by only one level>
- risk if removed: <what could fail undetected>
- review date: <DD/MM/YYYY>
```

### PR Enforcement Checklist (Test-Level Mapping)

For each new or changed test in a PR, include this checklist in the PR body:

- [ ] Every functional test file is mapped to exactly one primary level (`component-unit`, `integration`, `e2e`).
- [ ] Each mapping includes a one-line rationale tied to the level's primary risk.
- [ ] Any changed Storybook/Chromatic baseline is explicitly marked as `visual` evidence in the PR.
- [ ] Any intentional overlap follows the required exception protocol.
- [ ] No prohibited duplication is introduced.
- [ ] Mapping is consistent with required CI checks and branch protection intent (`vitest-tests` and `playwright-tests`).

### FR34 Accountability and NFR Linkage

| Requirement                                                | Auditable signal                                                                                       | Evidence source                                      | Accountability owner                |
| ---------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ | ---------------------------------------------------- | ----------------------------------- |
| FR34: explicit non-overlapping test-level responsibilities | 100% of PR test additions mapped to a single level with rationale                                      | PR checklist + changed test file paths               | PR author + reviewer                |
| NFR-T1: reduce flakiness                                   | Duplicate cross-level assertions trend downward and flaky retries do not increase for protected checks | CI history for `vitest-tests` and `playwright-tests` | Engineering owner for test quality  |
| NFR-T2: fast feedback                                      | Median PR check duration remains within team target while preserving level coverage boundaries         | GitHub Actions run durations                         | Engineering owner for delivery flow |

### Test Pyramid (Visual Overview)

```
    ╱╲
   ╱E2E╲          Playwright critical journeys
  ╱──────╲
     ╱ Visual ╲       Storybook/Chromatic visual baselines
    ╱──────────╲
   ╱Component-  ╲     Local component behavior + isolated logic
  ╱  Unit        ╲
  ╱──────────────╲
 ╱ Integration    ╲   Route composition and SSR contracts
╱──────────────────╲
  Functional base  Component-unit + integration foundations
```

### Test Helpers

- **Custom render** — Wraps components with necessary providers (`app/test/utils.tsx`)
- **checkAccessibility()** — jest-axe WCAG AA validation
- **PregnancySafeTestUtils** — Touch target (44px+), color safety, motion checks
- **Pregnancy personas** — Marie (3rd trimester), Sophie (morning sickness), Alexandra (postpartum)

### Running Tests

```bash
# Unit & Component tests (Vitest with browser mode)
npm run test

# Watch mode during development
npm run test:watch

# E2E tests (requires dev server running)
npm run dev  # Terminal 1
npm run test:e2e  # Terminal 2

# All tests
npm run test:all
```

## Code Quality

### TypeScript

- **Strict mode** enabled (`tsconfig.json`)
- Path aliases: `~/` maps to `./app/`
- Auto-generated route types via `react-router typegen`

### Formatting

- **Prettier** — Auto-format on save (configured in Dev Container)
- **Tab size**: 2 spaces
- **Editor**: Format on save enabled

### Code Analysis

- **Codacy** — Automated analysis via MCP server
- **ESLint** — Configuration via `.codacy/tools-configs/eslint.config.mjs`
- **Trivy** — Security vulnerability scanning

## File Organization Patterns

### Component Module Structure

```
component-name/
├── component-name.tsx        # Main component
├── sub-component.tsx         # Sub-components (if any)
├── component-name.stories.tsx # Storybook stories
├── design-rationale.stories.mdx # Design docs (optional)
└── index.ts                  # Barrel export
```

### Import Order Convention

1. React / framework imports
2. Third-party library imports
3. Internal absolute imports (`~/...`)
4. Relative imports (`./...`)

### Naming Conventions

| Type             | Convention                  | Example                                   |
| ---------------- | --------------------------- | ----------------------------------------- |
| Components       | PascalCase                  | `ContactForm`, `HeroContent`              |
| Files            | kebab-case                  | `contact-form.tsx`, `hero-animations.tsx` |
| Props interfaces | PascalCase + `Props`        | `ContactFormProps`, `HeroProps`           |
| Hooks            | camelCase with `use` prefix | `useMotionPreferences`                    |
| Data files       | kebab-case                  | `call-to-action.ts`                       |
| Server modules   | `.server.ts` suffix         | `email.server.ts`                         |
| Test files       | `.test.ts(x)` suffix        | `contact-form.test.tsx`                   |
| Story files      | `.stories.tsx` suffix       | `contact-form.stories.tsx`                |
| E2E specs        | `.spec.ts` suffix           | `homepage.spec.ts`                        |
