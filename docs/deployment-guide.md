# Deployment Guide

> Auto-generated by Document Project workflow on 2026-02-13.
> Mode: initial_scan | Scan Level: exhaustive

## Overview

The application is deployed on **Fly.io** in the **Toronto (yyz)** region, targeting a Canadian audience. Deployment is automated via GitHub Actions with a staging → production promotion pipeline.

## Architecture

```
┌─────────────────┐     ┌───────────────────┐     ┌─────────────────────┐
│  GitHub (main)  │────▶│  Staging (Fly.io) │────▶│ Production (Fly.io) │
│                 │push │   auto-deploy     │     │  release trigger    │
└─────────────────┘     └───────────────────┘     └─────────────────────┘
         │                       │                          │
         │               ┌──────┴───────┐           ┌──────┴───────┐
         │               │ Health Check │           │ Health Check │
         │               └──────────────┘           └──────────────┘
         │
    ┌────┴──────┐
    │ Rollback  │  (workflow_dispatch)
    └───────────┘
```

## Docker Build

The production Docker image uses a **multi-stage build** for optimized size:

| Stage                          | Base Image       | Purpose                                  |
| ------------------------------ | ---------------- | ---------------------------------------- |
| `development-dependencies-env` | `node:20-alpine` | Full `npm ci` install                    |
| `production-dependencies-env`  | `node:20-alpine` | `npm ci --omit=dev` (production only)    |
| `build-env`                    | `node:20-alpine` | `npm install && npm run build`           |
| **Final**                      | `node:20-alpine` | Runtime with production deps + built app |

### Security

- Non-root user: `reactuser` (UID 1001) in `nodejs` group (GID 1001)
- Only production node_modules and build output copied to final image
- Port 3000 exposed

### Build Locally

```bash
docker build -t shooting-star .
docker run -p 3000:3000 --env-file .env shooting-star
```

## Fly.io Configuration

**File**: `fly.toml`

| Setting        | Value                                    |
| -------------- | ---------------------------------------- |
| App name       | `shooting-star`                          |
| Primary region | `yyz` (Toronto)                          |
| Internal port  | 3000                                     |
| HTTPS          | Forced                                   |
| Auto-stop      | Enabled (stop when idle)                 |
| Auto-start     | Enabled                                  |
| Min machines   | 0                                        |
| VM CPU         | Shared, 1 vCPU                           |
| VM Memory      | 512 MB                                   |
| Static assets  | `/app/build/client` served at `/assets/` |

### Health Check

| Setting      | Value     |
| ------------ | --------- |
| Path         | `/health` |
| Method       | GET       |
| Interval     | 30s       |
| Timeout      | 5s        |
| Grace period | 5s        |

The `/health` route returns a JSON response with app status, timestamp, and environment info.

## CI/CD Pipelines

### 1. Deploy to Fly.io (`deploy-fly.yml`)

| Trigger                      | Job                    | Environment           |
| ---------------------------- | ---------------------- | --------------------- |
| Push to `main`               | `deploy-staging`       | Staging               |
| Release published            | `deploy-production`    | Production            |
| Manual (`workflow_dispatch`) | `deploy` or `rollback` | Staging or Production |

**Post-deployment**: Health check job runs automatically after any successful deploy/rollback (5 retries, 10s delay, 30s stabilization wait).

#### Secrets & Variables

| Type     | Name                        | Description                    |
| -------- | --------------------------- | ------------------------------ |
| Secret   | `FLY_API_TOKEN`             | Fly.io API authentication      |
| Variable | `FLYIO_STAGING_APP_NAME`    | Staging app name               |
| Variable | `FLYIO_PRODUCTION_APP_NAME` | Production app name            |
| Variable | `STAGING_HEALTH_URL`        | Staging health endpoint URL    |
| Variable | `PRODUCTION_HEALTH_URL`     | Production health endpoint URL |

### 2. PR Checks (`pr-checks.yml`)

Runs on every PR targeting `main`:

| Job                | Timeout | Description                                                |
| ------------------ | ------- | ---------------------------------------------------------- |
| `playwright-tests` | 10 min  | E2E tests with Chromium (HTML report uploaded as artifact) |
| `vitest-tests`     | 10 min  | Unit tests + Storybook play functions                      |

Both jobs use Node 20, `npm ci`, and Playwright Chromium browser.

### 3. Chromatic Visual Testing (`chromatic.yml`)

| Trigger        | Description                   |
| -------------- | ----------------------------- |
| PR to `main`   | Visual diff comparison        |
| Push to `main` | Baseline update (auto-accept) |

Features: `onlyChanged`, `exitOnceUploaded`, `exitZeroOnChanges`.

### 4. Deploy Storybook (`deploy-storybook.yml`)

| Trigger        | Target       |
| -------------- | ------------ |
| Push to `main` | GitHub Pages |
| Manual         | GitHub Pages |

URL: `https://flavius-atticae.github.io/shooting-star/`

Includes post-deploy health check (5 retries with 30s timeout).

> **Note**: Uses `rm -rf package-lock.json node_modules && npm install` to work around optional dependency resolution issues in CI.

## Rollback Procedures

### Automated Rollback (Recommended)

1. Go to **Actions** → **Deploy to Fly.io** → **Run workflow**
2. Select:
   - **Operation**: `rollback`
   - **Environment**: `staging` or `production`
   - **Rollback target** (optional): release version or Docker image tag
3. Click **Run workflow**

If no rollback target is specified, the system automatically rolls back to the previous successful release.

### Manual Rollback via CLI

```bash
# List recent releases
flyctl releases --app <app-name> --image -j

# Deploy a specific image
flyctl deploy --image registry.fly.io/<app-name>:<tag> --app <app-name>
```

### Rollback Verification

After any rollback:

1. Automated health check runs (5 retries, 10s intervals)
2. GitHub issue comment posted with rollback details
3. Manual verification recommended:

```bash
# Check app status
flyctl status --app <app-name>

# View recent logs
flyctl logs --app <app-name>

# Check health endpoint
curl https://<app-url>/health
```

## Environment Setup

### Staging

- Deployed automatically on every push to `main`
- Uses staging-specific app name and health URL
- Ideal for QA and pre-release testing

### Production

- Deployed on GitHub Release publication
- Uses production-specific app name and health URL
- Protected environment with approval gates (GitHub Environments)

### Environment Variables (Runtime)

Set in Fly.io via `flyctl secrets`:

```bash
flyctl secrets set RESEND_API_KEY=re_xxx --app <app-name>
flyctl secrets set RESEND_FROM_EMAIL=contact@domain.com --app <app-name>
flyctl secrets set RESEND_FROM_NAME="Pauline Roussel" --app <app-name>
flyctl secrets set CONTACT_REPLY_TO=pauline@domain.com --app <app-name>
flyctl secrets set HONEYPOT_ENCRYPTION_SEED=xxx --app <app-name>
```

## Monitoring

### Health Endpoint

```
GET /health → { "status": "ok", "timestamp": "...", "env": "..." }
```

### Fly.io Dashboard

```bash
flyctl dashboard --app <app-name>
flyctl status --app <app-name>
flyctl logs --app <app-name>
```

### Key Metrics to Watch

- **Response time** — Target < 200ms for server-rendered pages
- **Memory usage** — 512 MB allocated, watch for creep
- **Machine auto-stop** — Verify machines stop/start correctly
- **Health check failures** — Alert on consecutive failures
